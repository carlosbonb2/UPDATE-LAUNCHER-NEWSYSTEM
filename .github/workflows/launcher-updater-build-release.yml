name: 2 - Build LauncherUpdater Produção (Oficial)

on:
  push:
    tags:
      - 'v*'     # Ex: v1.0.0
      - '!*-rc*' # Ignora tags de teste

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
        
      - name: Extrair Versão
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart('v')
          echo "VERSION_NUMBER=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: pwsh

      - run: dotnet format --verify-no-changes --verbosity diagnostic
        
      # BUILD SINGLE FILE (Obrigatório)
      - name: Construir
        run: dotnet publish "LauncherUpdater/LauncherUpdater.csproj" --configuration Release --self-contained true -r win-x64 --output ./publish /p:TreatWarningsAsErrors=true /p:Version=${{ env.VERSION_NUMBER }} /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true
      
      # --- ASSINATURA (BLINDADA PARA NÃO FALHAR O BUILD) ---
      #- name: Assinar Executável (Totalmente Opcional)
      #  run: |
      #    $pfx = "${{ secrets.CODE_SIGNING_CERTIFICATE }}"
      #    if ([string]::IsNullOrWhiteSpace($pfx)) {
      #        Write-Host "⚠️ NENHUM CERTIFICADO. Pulando..."
      #        return
      #    }
      #
      #    try {
      #        [System.IO.File]::WriteAllBytes("signing_cert.pfx", [System.Convert]::FromBase64String($pfx))
      #        
      #        # Executa o Signtool sem travar o script se der erro
      #        & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /f "signing_cert.pfx" /p "${{ secrets.CODE_SIGNING_PASSWORD }}" /fd SHA256 /tr http://timestamp.digert.com /td SHA256 "publish\LauncherUpdater.exe"
      #        
      #        # Verifica o resultado manualmente
      #        if ($LASTEXITCODE -ne 0) {
      #            Write-Host "⚠️ AVISO: A assinatura falhou (Senha incorreta ou erro técnico)."
      #            Write-Host "➡️ O build continuará SEM assinatura."
      #            # O SEGREDINHO: Força o sucesso para o GitHub não cancelar o deploy
      #            $global:LastExitCode = 0 
      #        } else {
      #            Write-Host "✅ Assinatura concluída com sucesso."
      #        }
      #    }
      #    catch {
      #        Write-Host "⚠️ ERRO GERAL NA ASSINATURA: $_"
      #        $global:LastExitCode = 0
      #    }
      #  shell: pwsh
      # -----------------------------------------------------
        
      - name: Estruturar Pacote Release
        run: |
          $verNum = $env:VERSION_NUMBER 
          $folder = "v$verNum"
          
          New-Item -ItemType Directory -Force -Path "./release_pack/$folder"
          New-Item -ItemType Directory -Force -Path "./release_trigger"

          # ZIP
          $zipName = "launcherupdater_release.zip"
          Compress-Archive -Path ./publish/* -DestinationPath "./release_pack/$folder/$zipName"
          $hash = (Get-FileHash -Path "./release_pack/$folder/$zipName").Hash

          # JSON
          $urlBase = "${{ secrets.SFTP_URL_BASE_LAUNCHER_UPDATER }}"
          @{ Version = $verNum; Url = "$urlBase/$folder/$zipName"; Checksum = $hash } | ConvertTo-Json | Set-Content "./release_pack/$folder/LauncherUpdaterVersion.json"

          # MASTER
          @{ CurrentFolder = $folder } | ConvertTo-Json | Set-Content "./release_trigger/LauncherUpdaterVersionMaster.json"
        shell: pwsh

      - uses: softprops/action-gh-release@v2
        with:
          draft: false     
          prerelease: false 
          make_latest: true 
          files: |
            ./release_trigger/LauncherUpdaterVersionMaster.json
            ./release_pack/v${{ env.VERSION_NUMBER }}/* # <--- ADICIONE O 'v' AQUI ANTES DO $