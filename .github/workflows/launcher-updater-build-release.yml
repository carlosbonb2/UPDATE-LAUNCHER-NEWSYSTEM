name: 2 - Build e Release do LauncherUpdater (Central)

on:
  push:
    tags:
      - 'lu-v*' # Ex: lu-v1.0.0

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 1. C√≥digo
        uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
        
      - name: Extrair Vers√£o
        run: |
          # Extrai a vers√£o sem o prefixo 'lu-v'
          echo "VERSION_NUMBER=${{ github.ref_name }}".Replace("lu-v", "") | Out-File -FilePath $env:GITHUB_ENV
        shell: pwsh

      # Guardi√µes
      - name: üõ°Ô∏è Verificar Estilo
        run: dotnet format --verify-no-changes --verbosity diagnostic
      - name: üõ°Ô∏è Restaurar e Verificar Vulnerabilidades
        # Assumindo que o nome do projeto √© 'LauncherUpdater/LauncherUpdater.csproj'
        run: |
          dotnet restore "LauncherUpdater/LauncherUpdater.csproj" -r win-x64
          dotnet list "LauncherUpdater/LauncherUpdater.csproj" package --vulnerable --include-transitive
        
      - name: 2. Construir e Publicar
        run: dotnet publish "LauncherUpdater/LauncherUpdater.csproj" --configuration Release --self-contained true -r win-x64 --output ./publish /p:TreatWarningsAsErrors=true /p:Version=${{ env.VERSION_NUMBER }} /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true
      
      # --- Assinatura (Usando o bloco existente) ---
      - name: 3. Decodificar Certificado
        run: |
          $pfx_base_64 = "${{ secrets.CODE_SIGNING_CERTIFICATE }}"
          [System.IO.File]::WriteAllBytes("signing_cert.pfx", [System.Convert]::FromBase64String($pfx_base_64))
        shell: pwsh
      - uses: microsoft/setup-msbuild@v2
      - name: 4. Assinar execut√°vel
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /f "signing_cert.pfx" /p "${{ secrets.CODE_SIGNING_PASSWORD }}" /fd SHA256 /tr http://timestamp.digert.com /td SHA256 "publish\LauncherUpdater.exe"
        shell: pwsh
        continue-on-error: true 
      # ---------------------------------------------
        
      - name: 5. Estruturar Pacote Release
        run: |
          $verNum = $env:VERSION_NUMBER 
          $folder = "v$verNum" # Ex: v1.0.0
          
          New-Item -ItemType Directory -Force -Path "./release_pack/$folder"
          New-Item -ItemType Directory -Force -Path "./release_trigger"

          # ZIP (Cont√©m LauncherUpdater.exe e depend√™ncias)
          $zipName = "launcherupdater_release.zip"
          Compress-Archive -Path ./publish/* -DestinationPath "./release_pack/$folder/$zipName"
          $hash = (Get-FileHash -Path "./release_pack/$folder/$zipName").Hash

          # JSON DE DETALHES (LauncherUpdaterVersion.json)
          $urlBase = "${{ secrets.SFTP_URL_BASE_LAUNCHER_UPDATER }}" # Nova secret: URL base para o Updater
          
          @{ Version = $verNum; Url = "$urlBase/$folder/$zipName"; Checksum = $hash } | ConvertTo-Json | Set-Content "./release_pack/$folder/LauncherUpdaterVersion.json"

          # MASTER (LauncherUpdaterVersionMaster.json)
          @{ CurrentFolder = $folder } | ConvertTo-Json | Set-Content "./release_trigger/LauncherUpdaterVersionMaster.json"
        shell: pwsh

      - name: 6. Criar Release GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: LauncherUpdater ${{ github.ref_name }}
          files: |
            ./release_trigger/LauncherUpdaterVersionMaster.json
            ./release_pack/${{ env.VERSION_NUMBER }}/*