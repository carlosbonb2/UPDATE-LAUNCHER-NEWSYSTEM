name: Build e Release do LauncherUpdater

on:
  push:
    tags:
      - 'v*' # Ex: v1.0.0

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 1. C√≥digo
        uses: actions/checkout@v4

      - name: 2. Configura√ß√£o do .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # CORRE√á√ÉO: .NET 8 √© o LTS atual. 10 ainda n√£o existe.
      
      - name: 3. üõ°Ô∏è Guardi√£o de Formata√ß√£o
        run: dotnet format --verify-no-changes --verbosity diagnostic

      - name: 4. Restaurar depend√™ncias
        run: dotnet restore "LauncherUpdater/LauncherUpdater.csproj" -r win-x64
        
      - name: 5. üõ°Ô∏è Guardi√£o de Vulnerabilidades
        run: dotnet list "LauncherUpdater/LauncherUpdater.csproj" package --vulnerable --include-transitive

      - name: 6. Construir e Publicar
        run: dotnet publish "LauncherUpdater/LauncherUpdater.csproj" --configuration Release --self-contained true -r win-x64 --output ./publish /p:TreatWarningsAsErrors=true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      # --- Assinatura ---
      - name: 7. Decodificar Certificado
        run: |
          $pfx_base_64 = "${{ secrets.CODE_SIGNING_CERTIFICATE }}"
          [System.IO.File]::WriteAllBytes("signing_cert.pfx", [System.Convert]::FromBase64String($pfx_base_64))
        shell: pwsh

      - uses: microsoft/setup-msbuild@v2

      - name: 9. Assinar execut√°vel
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /f "signing_cert.pfx" /p "${{ secrets.CODE_SIGNING_PASSWORD }}" /fd SHA256 /tr http://timestamp.digert.com /td SHA256 "publish\LauncherUpdater.exe"
        shell: pwsh
        continue-on-error: true 
      # ------------------
        
      # --- GERA√á√ÉO DE HASH (CRUCIAL PARA O LAUNCHER CONFIAR) ---
      - name: 10. Gerar Hash de Verifica√ß√£o
        run: |
          $hash = (Get-FileHash -Path ./publish/LauncherUpdater.exe -Algorithm SHA256).Hash
          $hash | Set-Content -Path ./publish/LauncherUpdater_hash.txt
          echo "Hash gerado: $hash"
        shell: pwsh

      - name: 11. Criar Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: LauncherUpdater ${{ github.ref_name }}
          files: |
            ./publish/LauncherUpdater.exe
            ./publish/LauncherUpdater_hash.txt