name: Build e Release do LauncherUpdater

on:
  push:
    tags:
      - 'v*' # S√≥ executa quando voc√™ criar uma tag (ex: v1.0.0)

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write # Permiss√£o para criar a release

    steps:
      - name: 1. C√≥digo
        uses: actions/checkout@v4

      - name: 2. Configura√ß√£o do .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x' # Ajustado para .NET 10
      
      # Assumindo que o projeto est√° em "LauncherUpdater/LauncherUpdater.csproj"
      # Ajuste o caminho se necess√°rio
      
      - name: 3. üõ°Ô∏è Guardi√£o 1 Verificar Formata√ß√£o
        run: dotnet format --verify-no-changes --verbosity diagnostic

      - name: 4. Restaurar depend√™ncias
        run: dotnet restore "LauncherUpdater/LauncherUpdater.csproj" -r win-x64
        
      - name: 5. üõ°Ô∏è Guardi√£o 2 Verificar Pacotes Vulner√°veis
        run: dotnet list "LauncherUpdater/LauncherUpdater.csproj" package --vulnerable --include-transitive

      - name: 6. üõ°Ô∏è Guardi√£o 3 Construir e Publicar (Release + Auto-Suficiente)
        run: dotnet publish "LauncherUpdater/LauncherUpdater.csproj" --configuration Release --self-contained true -r win-x64 --output ./publish /p:TreatWarningsAsErrors=true

      # --- Bloco de Assinatura (Opcional, mas recomendado) ---
      - name: 7. Decodificar Certificado
        run: |
          $pfx_base_64_with_headers = "${{ secrets.CODE_SIGNING_CERTIFICATE }}"
          $pfx_path = "signing_cert.pfx"
          $pfx_base_64_raw = $pfx_base_64_with_headers -replace "-----BEGIN CERTIFICATE-----", "" -replace "-----END CERTIFICATE-----", "" -replace "\r", "" -replace "\n", ""
          [System.IO.File]::WriteAllBytes($pfx_path, [System.Convert]::FromBase64String($pfx_base_64_raw))
        shell: pwsh

      - name: 8. Adicionar MSBuild e Signtool ao PATH
        uses: microsoft/setup-msbuild@v2

      - name: 9. Assinar execut√°vel
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /f "signing_cert.pfx" /p "${{ secrets.CODE_SIGNING_PASSWORD }}" /fd SHA256 /tr http://timestamp.digert.com /td SHA256 "publish\LauncherUpdater.exe"
        shell: pwsh
        continue-on-error: true 
      # --- Fim do Bloco de Assinatura ---
        
      # --- CORRE√á√ÉO DE HASH (ESCRITA) ---
      - name: 10. Gerar Hash de Verifica√ß√£o
        run: |
          (Get-FileHash -Path ./publish/LauncherUpdater.exe -Algorithm SHA256).Hash | Set-Content -Path ./publish/LauncherUpdater_hash.txt
        shell: pwsh

      - name: 11. Criar Release e Anexar Artefatos
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: LauncherUpdater ${{ github.ref_name }}
          files: |
            ./publish/LauncherUpdater.exe
            ./publish/LauncherUpdater_hash.txt