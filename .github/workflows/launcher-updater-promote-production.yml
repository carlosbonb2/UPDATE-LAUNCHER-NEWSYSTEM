name: 3 - Promover LauncherUpdater Produ√ß√£o

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Tag da Release Oficial gerada no Passo 2 (ex: v1.0.0)'
        required: true
      confirmacao:
        description: 'Trava de Seguran√ßa: Digite PROMOVER para enviar ao cliente'
        required: true
        default: 'N√ÉO'

jobs:
  deploy-atomic:
    runs-on: windows-latest
    permissions:
      contents: read
      
    steps:
      # --- 1. TRAVA DE SEGURAN√áA HUMANA ---
      - name: üîí Verificar Confirma√ß√£o
        run: |
          if ("${{ github.event.inputs.confirmacao }}" -ne "PROMOVER") {
              Write-Error "‚ùå PROMO√á√ÉO CANCELADA: A palavra de seguran√ßa n√£o foi digitada corretamente."
              exit 1
          }
          Write-Host "‚úÖ Seguran√ßa validada. Iniciando promo√ß√£o..."
        shell: pwsh

      # --- 2. DOWNLOAD DOS ARTEFATOS DA RELEASE ---
      - name: üì¶ Baixar Release
        env: { GH_TOKEN: "${{ github.token }}" }
        run: |
          $TAG = "${{ github.event.inputs.version_tag }}"
          $VER = $TAG -replace '^v',''
          echo "VERSION_FOLDER=$VER" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          New-Item -ItemType Directory -Force -Path "./deploy_payload"
          New-Item -ItemType Directory -Force -Path "./deploy_trigger"
          
          try {
              gh release download "$TAG" --repo "${{ github.repository }}" --pattern "launcherupdater_release.zip" --dir "./deploy_payload"
              gh release download "$TAG" --repo "${{ github.repository }}" --pattern "LauncherUpdaterVersion.json" --dir "./deploy_payload"
              gh release download "$TAG" --repo "${{ github.repository }}" --pattern "LauncherUpdaterVersionMaster.json" --dir "./deploy_trigger"
          } catch {
              Write-Error "‚ùå ERRO FATAL: A tag '$TAG' n√£o existe ou os arquivos n√£o foram gerados no Passo 2."
              exit 1
          }
        shell: pwsh

      # --- 3. UPLOAD PARA PRODU√á√ÉO (CLIENTES) ---
      - name: üöÄ Deploy Pasta da Vers√£o (Payload)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local-dir: "./deploy_payload/"
          server-dir: "${{ secrets.SFTP_PATH_PRODUCAO_LAUNCHER_UPDATER }}/${{ github.event.inputs.version_tag }}/"

      - name: üéØ Deploy Gatilho (Master)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local-dir: "./deploy_trigger/"
          server-dir: "${{ secrets.SFTP_PATH_PRODUCAO_LAUNCHER_UPDATER }}/"