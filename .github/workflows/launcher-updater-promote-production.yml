name: 3 - Promover LauncherUpdater para Produ칞칚o (At칪mico)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Tag da Release (ex: lu-v1.0.1)'
        required: true

jobs:
  deploy-atomic:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: 1. Baixar e Organizar Release
        env: { GH_TOKEN: "${{ github.token }}" }
        run: |
          TAG="${{ github.event.inputs.version_tag }}"
          # Extrai a vers칚o real (ex: 1.0.1)
          VER=$(echo "$TAG" | sed 's/lu-v//')
          
          echo "Preparando deploy at칪mico da vers칚o $VER"
          
          # Cria estrutura tempor치ria separada
          mkdir -p "./deploy_payload" 
          mkdir -p "./deploy_trigger"
          
          # Baixa arquivos da vers칚o para a pasta de Payload
          gh release download "$TAG" --pattern "launcherupdater_release.zip" --dir "./deploy_payload"
          gh release download "$TAG" --pattern "LauncherUpdaterVersion.json" --dir "./deploy_payload"
          
          # Baixa o Master para a pasta de Gatilho
          gh release download "$TAG" --pattern "LauncherUpdaterVersionMaster.json" --dir "./deploy_trigger"
          
          # Salva a vers칚o em vari치vel para usar no pr칩ximo passo
          echo "VERSION_FOLDER=$VER" >> $GITHUB_ENV

      # PASSO 2: Envia a Carga 칔til (Pesada)
      - name: 2. 游닍 Enviar Arquivos da Vers칚o (Seguro)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          # Envia o conte칰do da pasta Payload
          local-dir: "./deploy_payload/"
          # Cria a pasta da vers칚o no servidor: /updates/LauncherUpdaterVersions/1.0.1/
          server-dir: "${{ secrets.SFTP_PATH_PRODUCAO_LAUNCHER_UPDATER }}/${{ env.VERSION_FOLDER }}/"

      # PASSO 3: Ativa칞칚o (R치pida e Leve)
      - name: 3. 游 Ativar Nova Vers칚o (Atualizar Master)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          # Envia o conte칰do da pasta Trigger
          local-dir: "./deploy_trigger/"
          # Joga na Raiz: /updates/LauncherUpdaterVersions/
          server-dir: "${{ secrets.SFTP_PATH_PRODUCAO_LAUNCHER_UPDATER }}/"