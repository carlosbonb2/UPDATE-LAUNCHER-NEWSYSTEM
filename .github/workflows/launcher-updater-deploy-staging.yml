name: 1 - Deploy LauncherUpdater Staging (Teste Seguro)

on:
  push:
    tags:
      - 'v*-rc' # Gatilho Novo: v1.0.0-rc

jobs:
  deploy-staging:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }

      # 1. Extração de Versão
      - name: Extrair Versão
        run: |
          $ver = "${{ github.ref_name }}".TrimStart('v').Split('-')[0]
          echo "VERSION_NUMBER=$ver" | Out-File -FilePath $env:GITHUB_ENV
        shell: pwsh

      # 2. Compilação (Single File - Cavalo de Troia)
      - name: Build Staging
        run: dotnet publish "LauncherUpdater/LauncherUpdater.csproj" --configuration Release --self-contained true -r win-x64 --output ./publish /p:Version=${{ env.VERSION_NUMBER }} /p:DefineConstants="STAGING" /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      # 3. --- SEGURANÇA: ASSINATURA DIGITAL ---
      - name: Decodificar Certificado
        run: |
          $pfx_base_64 = "${{ secrets.CODE_SIGNING_CERTIFICATE }}"
          [System.IO.File]::WriteAllBytes("signing_cert.pfx", [System.Convert]::FromBase64String($pfx_base_64))
        shell: pwsh

      - uses: microsoft/setup-msbuild@v2

      - name: Assinar Executável
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /f "signing_cert.pfx" /p "${{ secrets.CODE_SIGNING_PASSWORD }}" /fd SHA256 /tr http://timestamp.digert.com /td SHA256 "publish\LauncherUpdater.exe"
        shell: pwsh
        continue-on-error: true # Continua se falhar a assinatura (para teste), mas em prod deve parar
      # ----------------------------------------

      # 4. Empacotamento
      - name: Estruturar e Enviar
        run: |
          $folder = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path "./deploy/$folder"
          New-Item -ItemType Directory -Force -Path "./deploy/gatilho_ativacao"

          $zipName = "launcherupdater_release.zip"
          Compress-Archive -Path ./publish/* -DestinationPath "./deploy/$folder/$zipName"
          $hash = (Get-FileHash -Path "./deploy/$folder/$zipName").Hash
          
          $url = "${{ secrets.SFTP_URL_BASE_STAGING_LAUNCHER_UPDATER }}/$folder/$zipName"
          
          @{ Version = $env:VERSION_NUMBER; Url = $url; Checksum = $hash } | ConvertTo-Json | Set-Content -Path "./deploy/$folder/LauncherUpdaterVersion.json" -Encoding utf8
          @{ CurrentFolder = $folder } | ConvertTo-Json | Set-Content -Path "./deploy/gatilho_ativacao/LauncherUpdaterVersionMaster.json" -Encoding utf8
        shell: pwsh

      # 5. Upload
      - uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST_STAGING }}
          username: ${{ secrets.SFTP_USERNAME_STAGING }}
          password: ${{ secrets.SFTP_PASSWORD_STAGING }}
          local-dir: "./deploy/${{ github.ref_name }}/" 
          server-dir: "${{ secrets.SFTP_PATH_STAGING_LAUNCHER_UPDATER }}/${{ github.ref_name }}/"

      - uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.SFTP_HOST_STAGING }}
          username: ${{ secrets.SFTP_USERNAME_STAGING }}
          password: ${{ secrets.SFTP_PASSWORD_STAGING }}
          local-dir: "./deploy/gatilho_ativacao/"
          server-dir: "${{ secrets.SFTP_PATH_STAGING_LAUNCHER_UPDATER }}/"